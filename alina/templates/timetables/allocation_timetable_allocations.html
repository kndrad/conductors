{% extends '_page.html' %}

{% load static %}
{% load date_representations %}

{% block extra_title %}Plany | {% endblock %}

{% block navbar_buttons %}
    <a class="text-sm" href={{ caldav_account_href }}>
        CalDAV
    </a>
    <a class="text-sm" href={{ railroad_account_href }}>
        Stacje
    </a>
{% endblock %}

{% block content %}
    <div class="flex flex-col items-center text-white text-center px-2.5">
    {% if messages %}
         {% for message in messages %}
             <div>
                 {{ message|safe }}
             </div>
         {% endfor %}
    {% endif %}
    <a class="m-2 w-full py-2 px-4 block text-center bg-gray-800 text-sm rounded-xl" href="{% url 'import_allocation_timetable' %}">
        Importuj harmonogramy
    </a>

    <ul>
    {% for timetable in timetables %}
        <div class="mb-3 p-2 bg-white bg-opacity-5 rounded">
            <div class="m-1 py-1 px-2 border rounded">
                <span>{{ timetable.get_month_display }} {{ timetable.year }}</span>
            </div>
            <div class="m-1 text-sm py-1 px-4">
                <span>
                Ostatnia aktualizacja: {{ timetable.last_updated|represent_date }}
                </span>
            </div>
            <form method='POST' action='{% url 'update_allocations' timetable.pk %}'>
                {% csrf_token %}
                <button class="m-1 py-1 px-4 text-sm w-full bg-green-600 rounded">
                    Aktualizuj
                </button>
            </form>
            {% if timetable.allocation_set.exists %}
                <form method='POST' action='{% url 'send_allocation_timetable_to_dav_client' timetable.pk %}'>
                    {% csrf_token %}
                    <button>Wyślij kalendarz</button>
                </form>
                {% for allocation in timetable.allocation_set.all %}
                    <div>
                        {% if not allocation.train.before %}
                        <form method='POST' action="{% url 'search_train_before_allocation' allocation.pk %}">
                            {% csrf_token %}
                        <button>Wyszukaj pociąg przed</button>
                        </form>
                        {% else %}
                            <a href="{% url 'train_detail' allocation.train.before.pk %}">
                            {{ allocation.train.before }}
                            </a>
                        {% endif %}

                        <div>
                            <a href="{% url 'allocation_details' allocation.pk %}">
                            {{ allocation }}
                            </a>
                        </div>

                        {% if not allocation.train.after %}
                        <form method='POST' action="{% url 'search_train_after_allocation' allocation.pk %}">
                            {% csrf_token %}
                            <button>Wyszukaj pociąg po</button>
                        </form>
                        {% else %}
                            <a href="{% url 'train_detail' allocation.train.after.pk %}">
                            {{ allocation.train.after }}
                            </a>
                        {% endif %}
                    </div>
                {% endfor %}
            {% else %}
            <span class="text-red-500 font-semibold">Brak służb</span>
            {% endif %}
        </div>
    {% endfor %}
    </ul>
</div>
{% endblock content %}
