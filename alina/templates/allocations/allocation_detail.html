{% extends '_base.html' %}

{% load static %}
{% load alina_dates %}
{% load date_reprs %}

{% block extra_title %}{{ allocation.title }} | {% endblock %}

{% block header_nav %}
    <form method="POST" action='{% url 'update_allocation' allocation.pk %}'>{% csrf_token %}
        <button class="px-2 py-1 font-semibold">Aktualizuj</button>
    </form>
    <a href={{ railroad_account_href }}>
        Konto kolejowe
    </a>
{% endblock %}

{% block main %}
    <div class="flex items-center flex-col w-full px-2.5 mb-2">
        <p class="mb-1 italic tracking-tight">Ostatnia aktualizacja: {{ allocation.last_updated|full_date }}</p>
    {% if allocation.allocationdetailset.exists %}
        <p class="text-sm italic">Aby zobaczyć załogę, kliknij w numer pociągu.</p>
    {% endif %}
    </div>

    <div class="w-full flex-col p-1 px-2.5 pb-4 rounded">
        <div class="w-full text-center text-4xl font-bold tracking-wider my-2 mb-4">
            {{ allocation.title }}
        </div>
        <div class="flex justify-between space-x-1 px-1 border border-white mt-2 border-opacity-25 rounded">
            <div class="w-full mb-2 p-1 space-y-0.5">
                <div class="mb-3 text-center">
                    <p class="text-center text-sm italic">Początek</p>
                    <p class="tracking-tight text-lg">{{ allocation.start_date }}</p>
                </div>
                {% if user.railroad_account %}
                <div class="mb-2 space-y-1">
                    <p class="text-center text-sm italic mb-1">Pociąg przed służbą</p>
                    {% if allocation.train.before %}
                    <a href="{% url 'train_detail' allocation.train.before.pk %}">
                        <div class="flex items-center font-medium tracking-tighter justify-between rounded p-1.5">
                            <div>{{ allocation.train.before.departure_date|hour_only }}</div>
                            <div>{{ allocation.train.before.carrier_initials }} {{ allocation.train.before.number }}</div>
                            <div>{{ allocation.train.before.arrival_date|hour_only }}</div>
                        </div>
                    </a>
                    {% else %}
                        {% if not allocation.is_month_old %}
                            <div class="flex items-center rounded">
                                <form class="text-center w-full" method='POST' action="{% url 'search_train_before_allocation' allocation.pk %}">
                                {% csrf_token %}
                                    <button class="w-full p-1.5 font-medium tracking-tighter">Załaduj pociąg</button>
                                </form>
                            </div>
                        {% else %}
                            <div class="flex items-center p-1.5 rounded">
                                <div class="text-center w-full tracking-tighter text-sm">
                                    Czas na szukanie pociągu minął
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
                {% else %}
                    <div class="mb-2 py-1 w-full text-center rounded tracking-tighter">
                        Najpierw utwórz konto kolejowe!
                    </div>
                {% endif %}
            </div>
            <div class="w-full mb-2 p-1 space-y-0.5">
                <div class="mb-3 text-center">
                    <p class="text-center text-sm italic">Koniec</p>
                    <p class="tracking-tight text-lg">{{ allocation.end_date }}</p>
                </div>
                {% if user.railroad_account %}
                <div class="mb-2 space-y-1">
                    <p class="text-center text-sm italic mb-1">Pociąg po służbie</p>
                    {% if allocation.train.after %}
                        <a href="{% url 'train_detail' allocation.train.after.pk %}">
                            <div class="flex items-center font-medium tracking-tighter justify-between rounded p-1.5">
                                <div>{{ allocation.train.after.departure_date|hour_only }}</div>
                                <div>{{ allocation.train.after.carrier_initials }} {{ allocation.train.after.number }}</div>
                                <div>{{ allocation.train.after.arrival_date|hour_only }}</div>
                            </div>
                        </a>
                    {% else %}
                        {% if not allocation.is_month_old %}
                        <div class="flex items-center rounded">
                            <form class="text-center w-full" method='POST' action="{% url 'search_train_after_allocation' allocation.pk %}">
                            {% csrf_token %}
                                <button class="w-full p-1.5 font-medium tracking-tighter">Załaduj pociąg</button>
                            </form>
                        </div>
                        {% else %}
                            <div class="flex items-center p-1.5 rounded">
                                <div class="text-center w-full tracking-tighter text-sm">
                                    Czas na szukanie pociągu minął
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
                {% else %}
                    <div class="mb-2 py-1 w-full text-center rounded tracking-tighter">
                        Najpierw utwórz konto kolejowe!
                    </div>
                {% endif %}
            </div>
        </div>
        {% for detail in allocation.allocationdetail_set.all %}
            <div class="border border-white border-opacity-10 rounded my-3 text-center w-full">
                <div class="text-center text-xl m-1">
                    <div>{{ detail.action }}</div>
                </div>
                {% if detail.train_number %}
                <a href="{% url 'train_crew' detail.train_number detail.action_date|alina_date_str %}">
                    <div class="font-bold text-xl py-1 rounded w-11/12 mx-auto mb-3">
                        {{ detail.train_number }}
                    </div>
                </a>
            {% endif %}
                <div class="py-1 px-2">
                    <div class="flex items-center justify-between">
                        <div class="text-xs italic">Rozpoczęcie</div>
                        <div class="text-sm">{{ detail.start_location }} {{ detail.start_hour }}</div>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="text-xs italic">Koniec</div>
                        <div class="text-sm">{{ detail.end_location }} {{ detail.end_hour }}</div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% endblock main %}